(function(){var c={tblTitle:"",tblTitleId:"",tblBodyId:"",tblConf:[],tblDetailData:[]};var b={};$.fn.displayReport=function(d){$.extend(b,c,d);a.init();a.prepareTableData();a.displayTable();a.mergeCellByCol(0,0,0);a.mergeCellByRow();a.delHiddenCell()};var a={lastTblData:[],tmpFnDatas:[],lastGroupColIdx:-1,isRowGroupChanged:function(d){for(var e=0;e<b.tblConf.length;e++){if("G"==b.tblConf[e].type){if(b.tblDetailData[d][b.tblConf[e].colName]==b.tblDetailData[d-1][b.tblConf[e].colName]){continue}else{return e}}else{return -1}}return -1},isEmpty:function(d){if("undefined"==typeof(d)||null==d||""==d){return true}return false},resetTmpFnDatas:function(e){for(var d=e+1;d<a.tmpFnDatas.length;d++){a.tmpFnDatas[d]={}}},add:function(e,d){var f,g;if(a.isEmpty(e)){f=0}else{f=e}if(a.isEmpty(d)){g=0}else{g=d}return f+g},getTableByRowAndCol:function(e,d,f){return $("#"+e).find("tr").eq(d).find("td").eq(f).html()},setFnVal:function(e,d,f){if("sum"==b.tblConf[f].fn){e[b.tblConf[f].colName]=a.tmpFnDatas[d][b.tblConf[f].colName].sum}else{if("count"==b.tblConf[f].fn){e[b.tblConf[f].colName]=a.tmpFnDatas[d][b.tblConf[f].colName].count}else{if("max"==b.tblConf[f].fn){e[b.tblConf[f].colName]=a.tmpFnDatas[d][b.tblConf[f].colName].max}else{if("min"==b.tblConf[f].fn){e[b.tblConf[f].colName]=a.tmpFnDatas[d][b.tblConf[f].colName].min}else{if("avg"==b.tblConf[f].fn){e[b.tblConf[f].colName]=(a.tmpFnDatas[d][b.tblConf[f].colName].sum/a.tmpFnDatas[d][b.tblConf[f].colName].count).toFixed(2)}else{if(!a.isEmpty(b.tblConf[f].fn)){e[b.tblConf[f].colName]="计算值"}else{e[b.tblConf[f].colName]=""}}}}}}},init:function(){$("#"+b.tblTitleId).html(b.tblTitle);$("#"+b.tblBodyId).html("");a.tmpFnDatas.push({});for(var d=0;d<b.tblConf.length;d++){if(b.tblConf[d].type=="G"){a.tmpFnDatas.push({})}else{a.lastGroupColIdx=d-1;break}}},prepareTableData:function(){for(var f=0;f<b.tblDetailData.length;f++){var g={};if(0==f){for(var e=0;e<b.tblConf.length;e++){if("G"==b.tblConf[e].type){g[b.tblConf[e].colName]=b.tblDetailData[f][b.tblConf[e].colName]}else{g[b.tblConf[e].colName]=b.tblDetailData[f][b.tblConf[e].colName];if(!a.isEmpty(b.tblConf[e].fn)){for(var d=a.tmpFnDatas.length-1;d>=0;d--){a.tmpFnDatas[d][b.tblConf[e].colName]={};a.tmpFnDatas[d][b.tblConf[e].colName].sum=b.tblDetailData[f][b.tblConf[e].colName];a.tmpFnDatas[d][b.tblConf[e].colName].count=1;a.tmpFnDatas[d][b.tblConf[e].colName].max=b.tblDetailData[f][b.tblConf[e].colName];a.tmpFnDatas[d][b.tblConf[e].colName].min=b.tblDetailData[f][b.tblConf[e].colName];a.tmpFnDatas[d][b.tblConf[e].colName].avg=b.tblDetailData[f][b.tblConf[e].colName]}}}}a.lastTblData.push(g)}else{var h=a.isRowGroupChanged(f);if(0<=h){for(var o=a.lastGroupColIdx;o>=h;o--){var n={};for(var e=0;e<b.tblConf.length;e++){if(e==o){n[b.tblConf[e].colName]="小计"}else{if("G"==b.tblConf[e].type){if(e<o){n[b.tblConf[e].colName]=b.tblDetailData[f-1][b.tblConf[e].colName]}else{n[b.tblConf[e].colName]=""}}else{if(a.isEmpty(a.tmpFnDatas[o+1][b.tblConf[e].colName])){n[b.tblConf[e].colName]=""}else{a.setFnVal(n,o+1,e)}}}}a.lastTblData.push(n)}a.resetTmpFnDatas(h)}for(var e=0;e<b.tblConf.length;e++){if("G"==b.tblConf[e].type){g[b.tblConf[e].colName]=b.tblDetailData[f][b.tblConf[e].colName]}else{g[b.tblConf[e].colName]=b.tblDetailData[f][b.tblConf[e].colName];if(!a.isEmpty(b.tblConf[e].fn)){for(var d=a.tmpFnDatas.length-1;d>=0;d--){if(a.isEmpty(a.tmpFnDatas[d][b.tblConf[e].colName])){a.tmpFnDatas[d][b.tblConf[e].colName]={}}a.tmpFnDatas[d][b.tblConf[e].colName].sum=a.add(a.tmpFnDatas[d][b.tblConf[e].colName].sum,b.tblDetailData[f][b.tblConf[e].colName]);a.tmpFnDatas[d][b.tblConf[e].colName].count=a.add(a.tmpFnDatas[d][b.tblConf[e].colName].count,1);a.tmpFnDatas[d][b.tblConf[e].colName].max=(a.tmpFnDatas[d][b.tblConf[e].colName].max<b.tblDetailData[f][b.tblConf[e].colName])?b.tblDetailData[f][b.tblConf[e].colName]:a.tmpFnDatas[d][b.tblConf[e].colName].max;a.tmpFnDatas[d][b.tblConf[e].colName].min=(a.tmpFnDatas[d][b.tblConf[e].colName].min>b.tblDetailData[f][b.tblConf[e].colName])?b.tblDetailData[f][b.tblConf[e].colName]:a.tmpFnDatas[d][b.tblConf[e].colName].min;a.tmpFnDatas[d][b.tblConf[e].colName].avg=new Number((a.tmpFnDatas[d][b.tblConf[e].colName].sum/a.tmpFnDatas[d][b.tblConf[e].colName].count).toFixed(2))}}}}a.lastTblData.push(g)}}for(var k=a.tmpFnDatas.length-1;k>=0;k--){var n={};if(0==k){n[b.tblConf[0].colName]="总计";for(var l=1;l<b.tblConf.length;l++){if("G"==b.tblConf[l].type){n[b.tblConf[l].colName]=""}else{if(a.isEmpty(a.tmpFnDatas[k][b.tblConf[l].colName])){n[b.tblConf[l].colName]=""}else{a.setFnVal(n,k,l)}}}}else{for(var l=0;l<b.tblConf.length;l++){if(l==k-1){n[b.tblConf[l].colName]="小计"}else{if("G"==b.tblConf[l].type){if(l<(k-1)){n[b.tblConf[l].colName]=b.tblDetailData[b.tblDetailData.length-1][b.tblConf[l].colName]}else{n[b.tblConf[l].colName]=""}}else{if(a.isEmpty(a.tmpFnDatas[k][b.tblConf[l].colName])){n[b.tblConf[l].colName]=""}else{a.setFnVal(n,k,l)}}}}}a.lastTblData.push(n)}},displayTable:function(){var d="";for(var f=0;f<a.lastTblData.length;f++){d+="<tr>";for(var e=0;e<b.tblConf.length;e++){d+="<td>"+a.lastTblData[f][b.tblConf[e].colName]+"</td>"}d+="</tr>"}$("#"+b.tblBodyId).html(d)},mergeCellByCol:function(e,d,f){if(f>=b.tblConf.length){return}if(f==0||d==0){d=$("#"+b.tblBodyId).find("tr").length-1}for(var g=e;g<d;g++){if(!a.isEmpty(a.getTableByRowAndCol(b.tblBodyId,g+1,f))&&b.tblConf[f].merge&&(a.getTableByRowAndCol(b.tblBodyId,e,f)==a.getTableByRowAndCol(b.tblBodyId,g+1,f))){$("#"+b.tblBodyId).find("tr").eq(g+1).find("td").eq(f).css("display","none");var j=$("#"+b.tblBodyId).find("tr").eq(e).find("td").eq(f);var h=j.attr("rowspan");if("undefined"==typeof(h)){h=1}j.attr("rowspan",(h|0)+1);if(g==d-1&&e!=d){a.mergeCellByCol(e,d,f+1)}}else{a.mergeCellByCol(e,g,f+1);e=g+1}}},mergeCellByRow:function(){var m=$("#"+b.tblBodyId).find("tr").length;var e;for(var h=0;h<m;h++){e=$("#"+b.tblBodyId).find("tr").eq(h).find("td").length;for(var g=0;g<e;g++){if("小计"==a.getTableByRowAndCol(b.tblBodyId,h,g)||"总计"==a.getTableByRowAndCol(b.tblBodyId,h,g)){for(var f=g+1;f<=a.lastGroupColIdx;f++){$("#"+b.tblBodyId).find("tr").eq(h).find("td").eq(f).css("display","none");var l=$("#"+b.tblBodyId).find("tr").eq(h).find("td").eq(g);var d=l.attr("colspan");if("undefined"==typeof(d)){d=1}l.attr("colspan",(d|0)+1)}}}}},delHiddenCell:function(){var g=$("#"+b.tblBodyId).find("tr").length;var d;for(var f=0;f<g;f++){d=$("#"+b.tblBodyId).find("tr").eq(f).find("td").length;for(var e=d-1;e>=0;e--){if("none"==$("#"+b.tblBodyId).find("tr").eq(f).find("td").eq(e).css("display")){$("#"+b.tblBodyId).find("tr").eq(f).find("td").eq(e).remove()}}}}}})(jQuery);